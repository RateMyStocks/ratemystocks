<div class="portfolio-stocks-table-container">
  <div class="portfolios-table-filter">
    <mat-form-field appearance="outline">
      <mat-label>Search Holdings</mat-label>
      <input matInput placeholder="Search by Ticker/Company" (keyup)="applyFilter($event)" #input />
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Country</mat-label>
      <mat-select
        #countryFilterDropdown
        [formControl]="countries"
        (selectionChange)="applyFilterForDropdowns($event, FilterType.Country)"
        multiple
      >
        <mat-option *ngFor="let country of countryList" [value]="country">{{ country }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Sector</mat-label>
      <mat-select
        #sectorFilterDropdown
        [formControl]="sectors"
        (selectionChange)="applyFilterForDropdowns($event, FilterType.Sector)"
        multiple
      >
        <mat-option *ngFor="let sector of sectorList" [value]="sector">{{ sector }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Market Cap</mat-label>
      <mat-select
        #marketCapFilterDropdown
        [formControl]="marketCap"
        (selectionChange)="applyFilterForDropdowns($event, FilterType.MarketCap)"
        multiple
      >
        <mat-option *ngFor="let selectedMarketCap of marketCapList" [value]="selectedMarketCap">{{
          selectedMarketCap
        }}</mat-option>
      </mat-select>
    </mat-form-field>
    <button mat-raised-button color="warn" (click)="resetFilters()">Clear Filters</button>
  </div>

  <div>
    <table
      mat-table
      [dataSource]="dataSource"
      matSort
      matSortActive="weighting"
      matSortDisableClear
      matSortDirection="desc"
    >
      <ng-container matColumnDef="logo">
        <th mat-header-cell *matHeaderCellDef>
          <mat-icon style="color: lightgray;">pie_chart_outline</mat-icon>
        </th>
        <td mat-cell *matCellDef="let row">
          <!-- TODO: Find a way to do set a default without onerror -->
          <img
            class="stock-logo"
            *ngIf="iexStockDataMap"
            src="https://storage.googleapis.com/iex/api/logos/{{ row.ticker }}.png"
            onerror="this.onerror=null; this.src='assets/images/question-mark-placeholder.png'"
          />
        </td>
        <td mat-footer-cell *matFooterCellDef></td>
      </ng-container>
      <ng-container matColumnDef="ticker">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Ticker</th>
        <td mat-cell *matCellDef="let row">
          <a routerLink="/stocks/{{ row.ticker }}">{{ row.ticker }}</a>
        </td>
      </ng-container>
      <ng-container matColumnDef="companyName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Company</th>
        <td mat-cell *matCellDef="let row">
          <span *ngIf="iexStockDataMap">{{ iexStockDataMap[row.ticker]?.stats?.companyName }}</span>
          <mat-progress-bar *ngIf="!iexStockDataMap" mode="buffer"></mat-progress-bar>
        </td>
      </ng-container>
      <ng-container matColumnDef="weighting">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Weighting</th>
        <td mat-cell *matCellDef="let row" [style.color]="row.color">{{ row.weighting.toFixed(2) }}%</td>
      </ng-container>
      <ng-container matColumnDef="price">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Price</th>
        <td mat-cell *matCellDef="let row" [style.color]="row.color">
          <span *ngIf="iexStockDataMap">${{ iexStockDataMap[row.ticker]?.price?.toFixed(2) }}</span>
          <mat-progress-bar *ngIf="!iexStockDataMap" mode="buffer"></mat-progress-bar>
        </td>
      </ng-container>
      <ng-container matColumnDef="country">
        <th mat-header-cell *matHeaderCellDef>Country</th>
        <td mat-cell *matCellDef="let row">
          <span *ngIf="iexStockDataMap">{{ iexStockDataMap[row.ticker]?.company?.country }}</span>
          <mat-progress-bar *ngIf="!iexStockDataMap" mode="buffer"></mat-progress-bar>
        </td>
      </ng-container>
      <ng-container matColumnDef="sector">
        <th mat-header-cell *matHeaderCellDef>Sector</th>
        <td mat-cell *matCellDef="let row">
          <span *ngIf="iexStockDataMap">{{ iexStockDataMap[row.ticker]?.company?.sector }}</span>
          <mat-progress-bar *ngIf="!iexStockDataMap" mode="buffer"></mat-progress-bar>
        </td>
      </ng-container>
      <ng-container matColumnDef="dividendYield">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Div. Yield</th>
        <td mat-cell *matCellDef="let row">
          <span *ngIf="iexStockDataMap"
            >{{ (iexStockDataMap[row.ticker]?.stats?.dividendYield * 100)?.toFixed(2) }}%</span
          >
          <mat-progress-bar *ngIf="!iexStockDataMap" mode="buffer"></mat-progress-bar>
        </td>
      </ng-container>
      <ng-container matColumnDef="marketCap">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Market Cap</th>
        <td mat-cell *matCellDef="let row" [style.color]="row.color">
          <span *ngIf="iexStockDataMap"
            >${{ MoneyFormatter.formatCash(iexStockDataMap[row.ticker]?.stats?.marketcap) }}</span
          >
          <mat-progress-bar *ngIf="!iexStockDataMap" mode="buffer"></mat-progress-bar>
        </td>
      </ng-container>
      <ng-container matColumnDef="peRatio">
        <th mat-header-cell *matHeaderCellDef>P/E Ratio</th>
        <td mat-cell *matCellDef="let row">
          <span *ngIf="iexStockDataMap">{{ iexStockDataMap[row.ticker]?.stats?.peRatio?.toFixed(2) }}</span>
          <mat-progress-bar *ngIf="!iexStockDataMap" mode="buffer"></mat-progress-bar>
        </td>
        <td mat-footer-cell *matFooterCellDef></td>
      </ng-container>

      <!-- Additional info column that displays below the table data -->
      <ng-container matColumnDef="disclaimer">
        <td mat-footer-cell *matFooterCellDef colspan="10">
          <div class="porfolio-holdings-aggregate-data">
            <span id="top-ten-total-weighting" class="portfolio-table-summary-data"
              ><small>Total Top 10 Weighting: <strong>{{ topTenTotalWeighting.toFixed(2) }}%</strong></small>
            </span>
            <span id="weighted-avg-dividend-yield" class="portfolio-table-summary-data" *ngIf="iexStockDataMap">
              <small>
                Weighted Avg. Dividend Yield:
                <strong>{{ (calculateWeightedAvg('dividendYield') * 100).toFixed(2) }}%</strong>
              </small>
            </span>
            <span id="weighted-avg-market-cap" class="portfolio-table-summary-data" *ngIf="iexStockDataMap">
              <small>
                Weighted Avg. Market Cap:
                <strong>${{ MoneyFormatter.formatCash(calculateWeightedAvg('marketcap')) }}</strong>
              </small>
            </span>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <!-- Row shown when there is no matching data. -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="10">No results</td>
      </tr>

      <!-- Additional info row that displays below the table data -->
      <tr mat-footer-row *matFooterRowDef="['disclaimer']"></tr>
    </table>

    <mat-paginator [pageSizeOptions]="[10, 30]"></mat-paginator>
  </div>
</div>
